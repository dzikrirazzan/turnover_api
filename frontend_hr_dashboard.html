<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SMART-EN HR Analytics - Turnover Prediction</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <style>
      :root {
        --primary-color: #2563eb;
        --secondary-color: #64748b;
        --success-color: #059669;
        --warning-color: #d97706;
        --danger-color: #dc2626;
        --light-bg: #f8fafc;
      }

      body {
        background-color: var(--light-bg);
        font-family: "Inter", sans-serif;
      }

      .navbar {
        background: linear-gradient(135deg, var(--primary-color), #3b82f6);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease-in-out;
      }

      .card:hover {
        transform: translateY(-2px);
      }

      .btn-primary {
        background: var(--primary-color);
        border: none;
        border-radius: 8px;
        font-weight: 500;
      }

      .btn-primary:hover {
        background: #1d4ed8;
      }

      .upload-area {
        border: 2px dashed #cbd5e1;
        border-radius: 12px;
        padding: 3rem;
        text-align: center;
        background: #fff;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .upload-area:hover {
        border-color: var(--primary-color);
        background: #f0f9ff;
      }

      .upload-area.dragover {
        border-color: var(--primary-color);
        background: #eff6ff;
      }

      .progress-circle {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
      }

      .risk-high {
        background: var(--danger-color);
      }
      .risk-medium {
        background: var(--warning-color);
      }
      .risk-low {
        background: var(--success-color);
      }

      .prediction-row {
        transition: all 0.2s ease;
      }

      .prediction-row:hover {
        background-color: #f8fafc;
      }

      .loading {
        display: none;
      }

      .results-section {
        display: none;
      }

      .alert-custom {
        border-radius: 8px;
        border: none;
      }

      .stat-card {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border-radius: 12px;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .employee-badge {
        display: inline-block;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--primary-color);
        color: white;
        text-align: center;
        line-height: 40px;
        font-weight: bold;
        margin-right: 10px;
      }

      .recommendations-list {
        max-height: 200px;
        overflow-y: auto;
      }

      .recommendation-item {
        background: #f1f5f9;
        border-radius: 6px;
        padding: 8px 12px;
        margin: 4px 0;
        border-left: 3px solid var(--primary-color);
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-dark">
      <div class="container">
        <span class="navbar-brand mb-0 h1">
          <i class="fas fa-chart-line me-2"></i>
          SMART-EN HR Analytics
        </span>
        <div class="text-white">
          <i class="fas fa-user me-2"></i>
          <span id="username">HR Admin</span>
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <!-- Header -->
      <div class="row mb-4">
        <div class="col-12">
          <h2 class="text-dark mb-1">
            <i class="fas fa-users-cog me-2"></i>
            Employee Turnover Prediction
          </h2>
          <p class="text-muted">Upload employee data in CSV format to get turnover risk predictions</p>
        </div>
      </div>

      <!-- Login Section -->
      <div id="login-section" class="row justify-content-center">
        <div class="col-md-6">
          <div class="card">
            <div class="card-body p-4">
              <h4 class="card-title text-center mb-4">
                <i class="fas fa-sign-in-alt me-2"></i>
                Login to Continue
              </h4>
              <form id="login-form">
                <div class="mb-3">
                  <label for="username" class="form-label">Username</label>
                  <input type="text" class="form-control" id="login-username" value="admin" required />
                </div>
                <div class="mb-3">
                  <label for="password" class="form-label">Password</label>
                  <input type="password" class="form-control" id="login-password" value="newstrongpassword123" required />
                </div>
                <button type="submit" class="btn btn-primary w-100">
                  <i class="fas fa-sign-in-alt me-2"></i>
                  Login
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div id="main-content" style="display: none">
        <!-- Upload Section -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title mb-3">
                  <i class="fas fa-upload me-2"></i>
                  Upload Employee Data
                </h5>

                <div class="upload-area" id="upload-area">
                  <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                  <h5 class="text-dark">Drag & Drop CSV File Here</h5>
                  <p class="text-muted mb-3">or click to browse files</p>
                  <input type="file" id="csv-file" accept=".csv" style="display: none" />
                  <button type="button" class="btn btn-primary" onclick="document.getElementById('csv-file').click()">
                    <i class="fas fa-file-csv me-2"></i>
                    Choose CSV File
                  </button>
                  <div class="mt-3">
                    <small class="text-muted">
                      <a href="#" id="download-template" class="text-decoration-none">
                        <i class="fas fa-download me-1"></i>
                        Download CSV Template
                      </a>
                    </small>
                  </div>
                </div>

                <div id="file-info" class="mt-3" style="display: none">
                  <div class="alert alert-info alert-custom">
                    <i class="fas fa-file-csv me-2"></i>
                    <span id="file-name"></span>
                    <span class="badge bg-primary ms-2" id="file-size"></span>
                  </div>
                  <button type="button" class="btn btn-success" id="process-btn">
                    <i class="fas fa-cogs me-2"></i>
                    Process Predictions
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Loading Section -->
        <div class="row loading" id="loading-section">
          <div class="col-12">
            <div class="card">
              <div class="card-body text-center p-5">
                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <h5 class="text-dark">Processing Employee Data...</h5>
                <p class="text-muted">Our AI model is analyzing turnover predictions. Please wait.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="results-section">
          <!-- Summary Statistics -->
          <div class="row mb-4">
            <div class="col-12">
              <h5 class="text-dark mb-3">
                <i class="fas fa-chart-bar me-2"></i>
                Prediction Summary
              </h5>
              <div class="summary-grid" id="summary-grid">
                <!-- Summary cards will be populated here -->
              </div>
            </div>
          </div>

          <!-- Results Table -->
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>
                    Employee Predictions
                  </h5>
                  <button class="btn btn-outline-primary btn-sm" id="export-results">
                    <i class="fas fa-download me-2"></i>
                    Export Results
                  </button>
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-hover mb-0">
                      <thead class="table-light">
                        <tr>
                          <th>Employee</th>
                          <th>Department</th>
                          <th>Satisfaction</th>
                          <th>Risk Level</th>
                          <th>Probability</th>
                          <th>Recommendations</th>
                        </tr>
                      </thead>
                      <tbody id="results-table-body">
                        <!-- Results will be populated here -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
      // Configuration
      const API_BASE_URL = "https://turnover-api-hd7ze.ondigitalocean.app";
      let authToken = null;

      // Authentication
      document.getElementById("login-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = document.getElementById("login-username").value;
        const password = document.getElementById("login-password").value;

        try {
          const response = await fetch(`${API_BASE_URL}/api/auth/login/`, {
            method: "POST",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ username, password }),
          });

          const data = await response.json();

          if (response.ok) {
            authToken = data.auth_header || data.auth_token || `Basic ${data.token}`;
            document.getElementById("username").textContent = username;
            document.getElementById("login-section").style.display = "none";
            document.getElementById("main-content").style.display = "block";
          } else {
            alert("Login failed: " + (data.error || "Invalid credentials"));
          }
        } catch (error) {
          console.error("Login error:", error);
          if (error.name === "TypeError" && error.message.includes("fetch")) {
            alert("Connection error: Unable to connect to server. Please check your internet connection and try again.");
          } else {
            alert("Login error: " + error.message);
          }
        }
      });

      // File upload handling
      const uploadArea = document.getElementById("upload-area");
      const fileInput = document.getElementById("csv-file");
      const fileInfo = document.getElementById("file-info");
      const fileName = document.getElementById("file-name");
      const fileSize = document.getElementById("file-size");
      let selectedFile = null;

      // Drag and drop
      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.classList.remove("dragover");
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileSelect(files[0]);
        }
      });

      uploadArea.addEventListener("click", () => {
        fileInput.click();
      });

      fileInput.addEventListener("change", (e) => {
        if (e.target.files.length > 0) {
          handleFileSelect(e.target.files[0]);
        }
      });

      function handleFileSelect(file) {
        if (file.type !== "text/csv" && !file.name.endsWith(".csv")) {
          alert("Please select a CSV file");
          return;
        }

        selectedFile = file;
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        fileInfo.style.display = "block";
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      // Process predictions
      document.getElementById("process-btn").addEventListener("click", async () => {
        if (!selectedFile) {
          alert("Please select a CSV file first");
          return;
        }

        document.getElementById("loading-section").style.display = "block";
        document.getElementById("results-section").style.display = "none";

        try {
          // Read CSV file
          const text = await selectedFile.text();
          const lines = text.split("\n").filter((line) => line.trim());
          const headers = lines[0].split(",").map((h) => h.trim());

          // Parse CSV data
          const employees = [];
          for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(",").map((v) => v.trim());
            if (values.length >= headers.length) {
              const employee = {};
              headers.forEach((header, index) => {
                let value = values[index];

                // Convert data types
                if (header === "satisfaction_level" || header === "last_evaluation") {
                  employee[header] = parseFloat(value);
                } else if (header === "number_project" || header === "average_monthly_hours" || header === "time_spend_company") {
                  employee[header] = parseInt(value);
                } else if (header === "work_accident" || header === "promotion_last_5years") {
                  employee[header] = value.toLowerCase() === "true";
                } else {
                  employee[header] = value;
                }
              });
              employees.push(employee);
            }
          }

          // Use bulk predict endpoint
          const response = await fetch(`${API_BASE_URL}/api/predictions/bulk_predict/`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: authToken,
            },
            body: JSON.stringify({ employees: employees }),
          });

          const data = await response.json();
          document.getElementById("loading-section").style.display = "none";

          if (response.ok) {
            // Transform bulk predict response to match expected format
            const transformedData = {
              success: true,
              total_employees: data.predictions.length,
              summary: {
                high_risk_count: data.predictions.filter((p) => p.risk_level === "High").length,
                medium_risk_count: data.predictions.filter((p) => p.risk_level === "Medium").length,
                low_risk_count: data.predictions.filter((p) => p.risk_level === "Low").length,
                average_probability: data.predictions.reduce((sum, p) => sum + p.probability, 0) / data.predictions.length,
                high_risk_percentage: ((data.predictions.filter((p) => p.risk_level === "High").length / data.predictions.length) * 100).toFixed(1),
              },
              predictions: data.predictions.map((p) => ({
                employee_id: p.employee_id,
                employee_name: employees.find((e) => e.employee_id === p.employee_id)?.name || p.employee_id,
                department: employees.find((e) => e.employee_id === p.employee_id)?.department || "Unknown",
                satisfaction_level: employees.find((e) => e.employee_id === p.employee_id)?.satisfaction_level || 0,
                turnover_probability: p.probability,
                risk_level: p.risk_level.toUpperCase(),
                prediction: p.prediction,
                recommendations: ["Employee analysis completed", "Monitor performance indicators"],
              })),
            };

            displayResults(transformedData);
          } else {
            alert("Error processing file: " + (data.error || "Unknown error"));
          }
        } catch (error) {
          document.getElementById("loading-section").style.display = "none";
          alert("Network error: " + error.message);
        }
      });

      // Display results
      function displayResults(data) {
        // Update summary
        const summaryGrid = document.getElementById("summary-grid");
        summaryGrid.innerHTML = `
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <h3 class="mb-1">${data.total_employees}</h3>
                        <small>Total Employees</small>
                    </div>
                </div>
                <div class="card" style="background: linear-gradient(135deg, #dc2626, #ef4444); color: white;">
                    <div class="card-body text-center">
                        <h3 class="mb-1">${data.summary.high_risk_count}</h3>
                        <small>High Risk</small>
                    </div>
                </div>
                <div class="card" style="background: linear-gradient(135deg, #d97706, #f59e0b); color: white;">
                    <div class="card-body text-center">
                        <h3 class="mb-1">${data.summary.medium_risk_count}</h3>
                        <small>Medium Risk</small>
                    </div>
                </div>
                <div class="card" style="background: linear-gradient(135deg, #059669, #10b981); color: white;">
                    <div class="card-body text-center">
                        <h3 class="mb-1">${data.summary.low_risk_count}</h3>
                        <small>Low Risk</small>
                    </div>
                </div>
                <div class="card" style="background: linear-gradient(135deg, #7c3aed, #8b5cf6); color: white;">
                    <div class="card-body text-center">
                        <h3 class="mb-1">${data.summary.high_risk_percentage}%</h3>
                        <small>Risk Percentage</small>
                    </div>
                </div>
            `;

        // Update table
        const tableBody = document.getElementById("results-table-body");
        tableBody.innerHTML = data.predictions
          .map(
            (pred) => `
                <tr class="prediction-row">
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="employee-badge">${getInitials(pred.employee_name)}</div>
                            <div>
                                <div class="fw-bold">${pred.employee_name}</div>
                                <small class="text-muted">${pred.employee_id}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-secondary">${pred.department.toUpperCase()}</span>
                    </td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar ${getSatisfactionColor(pred.satisfaction_level)}" 
                                 style="width: ${pred.satisfaction_level * 100}%">
                                ${Math.round(pred.satisfaction_level * 100)}%
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge ${getRiskBadgeClass(pred.risk_level)}">
                            ${pred.risk_level}
                        </span>
                    </td>
                    <td>
                        <div class="progress-circle risk-${pred.risk_level.toLowerCase()}" style="width: 50px; height: 50px; font-size: 12px;">
                            ${Math.round(pred.turnover_probability * 100)}%
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-outline-info btn-sm" onclick="showRecommendations('${pred.employee_id}', ${JSON.stringify(pred.recommendations).replace(/"/g, "&quot;")})">
                            <i class="fas fa-lightbulb me-1"></i>
                            View
                        </button>
                    </td>
                </tr>
            `
          )
          .join("");

        document.getElementById("results-section").style.display = "block";
        window.currentResults = data; // Store for export
      }

      function getInitials(name) {
        return name
          .split(" ")
          .map((n) => n[0])
          .join("")
          .substr(0, 2)
          .toUpperCase();
      }

      function getSatisfactionColor(level) {
        if (level >= 0.7) return "bg-success";
        if (level >= 0.4) return "bg-warning";
        return "bg-danger";
      }

      function getRiskBadgeClass(level) {
        switch (level) {
          case "HIGH":
            return "bg-danger";
          case "MEDIUM":
            return "bg-warning";
          case "LOW":
            return "bg-success";
          default:
            return "bg-secondary";
        }
      }

      function showRecommendations(employeeId, recommendations) {
        const modal = new bootstrap.Modal(document.createElement("div"));
        modal._element.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Recommendations for ${employeeId}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="recommendations-list">
                                ${recommendations
                                  .map(
                                    (rec) => `
                                    <div class="recommendation-item">
                                        <i class="fas fa-arrow-right me-2"></i>
                                        ${rec}
                                    </div>
                                `
                                  )
                                  .join("")}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        document.body.appendChild(modal._element);
        modal.show();

        modal._element.addEventListener("hidden.bs.modal", () => {
          document.body.removeChild(modal._element);
        });
      }

      // Download template
      document.getElementById("download-template").addEventListener("click", async (e) => {
        e.preventDefault();

        // Create template data
        const templateData = [
          ["employee_id", "name", "satisfaction_level", "last_evaluation", "number_project", "average_monthly_hours", "time_spend_company", "work_accident", "promotion_last_5years", "salary", "department"],
          ["EMP001", "John Doe", "0.75", "0.85", "4", "180", "3", "false", "false", "medium", "IT"],
          ["EMP002", "Jane Smith", "0.45", "0.60", "2", "250", "6", "true", "false", "low", "sales"],
          ["EMP003", "Bob Johnson", "0.80", "0.90", "5", "160", "2", "false", "true", "high", "engineering"],
          ["EMP004", "Alice Wilson", "0.35", "0.45", "3", "280", "4", "false", "false", "low", "marketing"],
          ["EMP005", "Charlie Brown", "0.85", "0.95", "6", "170", "1", "false", "false", "high", "IT"],
        ];

        // Convert to CSV
        const csv = templateData.map((row) => row.join(",")).join("\n");

        // Download
        const blob = new Blob([csv], { type: "text/csv" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "turnover_prediction_template.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      });

      // Export results
      document.getElementById("export-results").addEventListener("click", () => {
        if (!window.currentResults) {
          alert("No results to export");
          return;
        }

        const csv = convertToCSV(window.currentResults.predictions);
        const blob = new Blob([csv], { type: "text/csv" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `turnover_predictions_${new Date().toISOString().split("T")[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      });

      function convertToCSV(data) {
        const headers = ["Employee ID", "Name", "Department", "Satisfaction Level", "Risk Level", "Turnover Probability"];
        const rows = data.map((pred) => [pred.employee_id, pred.employee_name, pred.department, pred.satisfaction_level, pred.risk_level, pred.turnover_probability]);

        return [headers, ...rows].map((row) => row.join(",")).join("\n");
      }
    </script>
  </body>
</html>
