# Generated by Django 4.2.7 on 2025-01-04 15:00

from django.db import migrations


def ensure_abstractuser_columns(apps, schema_editor):
    """
    Ensure all AbstractUser columns exist in the predictions_employee table.
    This handles cases where columns might be missing in production.
    """
    from django.db import connection
    
    # Required AbstractUser columns with their SQL definitions
    required_columns = {
        'password': "VARCHAR(128) NOT NULL DEFAULT ''",
        'last_login': "DATETIME(6) NULL",
        'is_superuser': "TINYINT(1) NOT NULL DEFAULT 0",
        'is_staff': "TINYINT(1) NOT NULL DEFAULT 0", 
        'is_active': "TINYINT(1) NOT NULL DEFAULT 1",
        'date_joined': "DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6)"
    }
    
    with connection.cursor() as cursor:
        # Get existing columns
        cursor.execute("""
            SELECT COLUMN_NAME 
            FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE TABLE_SCHEMA = DATABASE() 
            AND TABLE_NAME = 'predictions_employee'
        """)
        
        existing_columns = {row[0] for row in cursor.fetchall()}
        print(f"Existing columns: {existing_columns}")
        
        # Add missing columns
        for column_name, column_def in required_columns.items():
            if column_name not in existing_columns:
                print(f"Adding missing column: {column_name}")
                cursor.execute(f"""
                    ALTER TABLE predictions_employee 
                    ADD COLUMN {column_name} {column_def}
                """)
                print(f"Column {column_name} added successfully!")
            else:
                print(f"Column {column_name} already exists, skipping...")


def reverse_ensure_abstractuser_columns(apps, schema_editor):
    """
    Reverse operation - we don't want to drop the AbstractUser columns
    """
    pass


class Migration(migrations.Migration):

    dependencies = [
        ('predictions', '0001_initial'),
    ]

    operations = [
        migrations.RunPython(ensure_abstractuser_columns, reverse_ensure_abstractuser_columns),
    ]
